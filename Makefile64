BINDIR=bin
OBJDIR=obj
SRCDIR=test
GPP=gcc
LIBS=-lSDL2 -lc

SMOLDIR=smol
INCLUDEDIR=$(SMOLDIR)/rt

ASFLAGS=-I $(INCLUDEDIR)
ASFLAGS +=-f elf64
ASFLAGS +=-DUSE_INTERP -DNO_START_ARG -DUNSAFE_DYNAMIC -DUSE_DNLOAD_LOADER  #-DALIGN_STACK


COPTFLAGS=-Os -s
COPTFLAGS+= -fno-plt
COPTFLAGS+= -fwhole-program
COPTFLAGS+= -fno-stack-protector
COPTFLAGS+= -fno-stack-check
COPTFLAGS+= -fno-unwind-tables
COPTFLAGS+= -fno-asynchronous-unwind-tables
COPTFLAGS+= -fno-exceptions
COPTFLAGS+= -funsafe-math-optimizations
COPTFLAGS+= -fomit-frame-pointer
COPTFLAGS+= -ffast-math
COPTFLAGS+= -no-pie
COPTFLAGS+= -fno-pic
COPTFLAGS+= -march=nano
COPTFLAGS+= -mtune=nano
COPTFLAGS+= -ffunction-sections
COPTFLAGS+= -fdata-sections
COPTFLAGS+= -fno-plt 
# COPTFLAGS+= -nostartfiles -nostdlib

SFLAGS=  -R .comment
SFLAGS+= -R .plt
SFLAGS+= -R .got.plt
SFLAGS+= -R .gnu.hash
SFLAGS+= -R .gnu.version 
SFLAGS+= -R .eh_frame
SFLAGS+= -R .eh_frame_hdr
SFLAGS+= -R .note.ABI-tag
SFLAGS+= -R .got
SFLAGS+= -R .tm_clone_table


LDFLAGS=-Wl,--build-id=none -Wl,--hash-style=gnu -Wl,-z,norelro #-fuse-ld=gold

%/:
	mkdir -p $@

$(OBJDIR)/%.o: $(SRCDIR)/%.c $(OBJDIR)/
	$(GPP) -c $(LIBS) $(COPTFLAGS) $< -o $@

$(BINDIR)/%: $(OBJDIR)/%.o $(BINDIR)/
	./$(SMOLDIR)/src/smol.py $(LIBS) $< $(OBJDIR)/smol.asm
	nasm $(ASFLAGS) -o $< $(OBJDIR)/smol.asm
	$(GPP) -T smol/ld/link.ld -Wl,--oformat=binary $(LDFLAGS)
	#$(GPP) $(LIBS) $(COPTFLAGS) $(LDFLAGS) $< -o $@

all: $(BINDIR)/tetris
	strip $(SFLAGS) $<
	readelf -et $<
	sstrip -z $<
	lzma --format=lzma -9 --extreme --lzma1=preset=9,lc=1,lp=0,pb=0 $<
	cat ext/shelldropper $<.lzma > $<
	chmod +x $<
	rm $<.lzma
	wc -c $<
	# rm -rf $(OBJDIR)


clean:
	rm -rf $(OBJDIR) $(BINDIR)